version: "3"

vars:
  GOLANGCI_LINT_VERSION: v1.61.0

tasks:
  build-generator:
    generates:
      - bin/generator
    cmds:
      - go build -o bin/generator gen/main.go

  docs:
    cmds:
      - go run golang.org/x/pkgsite/cmd/pkgsite@latest

  generate:
    generates:
      - "**/*.gen.go"
    deps:
      - task: build-generator
    cmds:
      - go generate ./...

  lint:
    cmds:
      - docker run -t --rm -v $(pwd):/app -w /app golangci/golangci-lint:{{ .GOLANGCI_LINT_VERSION }} golangci-lint run -v

  test:
    cmds:
      - task: generate
      - go test -v ./...

  prepare:
    cmds:
      - task: generate
      - go fmt ./...
      - task: lint
      - task: test
